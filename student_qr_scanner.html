<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan QR Code</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html5-qrcode CDN for QR scanning -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* Custom styles for Inter font and general body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 1rem; /* Add some padding for smaller screens */
            box-sizing: border-box;
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Style for the QR code scanner area */
        #qr-reader {
            width: 100%;
            max-width: 400px; /* Limit max width for better mobile display */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            background-color: #333; /* Placeholder background for video feed */
            display: block; /* Ensure it takes full width */
            margin: 0 auto; /* Center the video */
            overflow: hidden; /* Ensure rounded corners apply to video */
        }
        /* Styles for the custom message box */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            text-align: center;
            min-width: 250px;
            max-width: 90%;
            border: 1px solid #e2e8f0;
        }
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .message-box h3 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #333;
        }
        .message-box p {
            margin-bottom: 1.5rem;
            color: #555;
        }
        .message-box button {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .message-box button:hover {
            background-color: #2563eb; /* blue-600 */
        }
    </style>
</head>
<body>
    <div class="flex flex-col items-center justify-center w-full max-w-md p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <!-- Application Title -->
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">
            Pharmawiz Attendance
        </h1>

        <!-- Page Title -->
        <h2 class="text-2xl font-bold text-gray-700 mb-8 text-center">
            Scan QR Code
        </h2>

        <!-- QR Scanner Container -->
        <div id="qr-reader" class="mb-8"></div>

        <!-- Message area (for success/error messages) -->
        <div id="message-area" class="text-center text-lg font-medium text-gray-600">
            Point your camera at the QR code.
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden mt-4 text-blue-600 font-semibold">
            Processing...
        </div>
    </div>

    <script>
        // Function to show a custom message box instead of alert()
        function showMessageBox(title, message, callback) {
            const overlay = document.createElement('div');
            overlay.className = 'message-box-overlay';
            document.body.appendChild(overlay);

            const messageBox = document.createElement('div');
            messageBox.className = 'message-box';
            messageBox.innerHTML = `
                <h3>${title}</h3>
                <p>${message}</p>
                <button id="messageBoxOkBtn">OK</button>
            `;
            document.body.appendChild(messageBox);

            document.getElementById('messageBoxOkBtn').onclick = () => {
                document.body.removeChild(overlay);
                document.body.removeChild(messageBox);
                if (callback) callback();
            };
        }

        const messageArea = document.getElementById('message-area');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Base URL for your Django backend API
        const API_BASE_URL = 'http://127.0.0.1:8000/api';

        // Retrieve student_id from sessionStorage
        const studentId = sessionStorage.getItem('student_id');
        const studentUsername = sessionStorage.getItem('student_username');

        // Redirect to login if student_id is not found (not logged in)
        if (!studentId) {
            showMessageBox('Session Expired', 'Please sign in again.', () => {
                window.location.href = 'student_signin.html';
            });
        } else {
            messageArea.textContent = `Hello, ${studentUsername}! Point your camera at the QR code.`;
        }

        // Initialize Html5QrcodeScanner
        const html5QrCode = new Html5Qrcode("qr-reader");

        // Configuration for the QR scanner
        const qrCodeConfig = {
            fps: 10, // Frames per second to scan QR code. If not specified, defaults to 2.
            qrbox: { width: 250, height: 250 }, // Size of the QR scanning box
            rememberLastUsedCamera: true, // Remember the last used camera for future sessions.
            supportedScanFormats: [Html5QrcodeSupportedFormats.QR_CODE], // Only scan QR codes
            // facingMode: "environment" // Use the rear camera by default
        };

        // This flag prevents multiple attendance markings from a single scan
        let attendanceMarked = false;

        // Function to handle successful QR code scan
        const onScanSuccess = async (decodedText, decodedResult) => {
            if (attendanceMarked) {
                return; // Already processed this scan or a previous one
            }

            console.log(`QR Code scanned: ${decodedText}`);
            messageArea.textContent = `QR Code detected! Processing...`;
            loadingIndicator.classList.remove('hidden'); // Show loading indicator

            // Stop the scanner to prevent multiple scans
            html5QrCode.stop().then(() => {
                console.log("QR Code scanner stopped.");
            }).catch(err => {
                console.error("Error stopping QR scanner:", err);
            });

            // Parse QR code data (expecting "LecturerID:L001,SubjectID:S005")
            const parts = decodedText.split(',');
            let lecturerIdFromQR = null;
            let subjectIdFromQR = null;

            parts.forEach(part => {
                const [key, value] = part.split(':');
                if (key === 'LecturerID') {
                    lecturerIdFromQR = value;
                } else if (key === 'SubjectID') {
                    subjectIdFromQR = value;
                }
            });

            if (!lecturerIdFromQR || !subjectIdFromQR) {
                showMessageBox('Scan Error', 'Invalid QR code format. Please scan a valid attendance QR code.', () => {
                    // Restart scanner after user acknowledges error
                    startScanner();
                });
                loadingIndicator.classList.add('hidden');
                return;
            }

            // Convert IDs to numbers if they are strings (from QR code)
            const parsedLecturerId = parseInt(lecturerIdFromQR);
            const parsedSubjectId = parseInt(subjectIdFromQR);

            if (isNaN(parsedLecturerId) || isNaN(parsedSubjectId)) {
                showMessageBox('Scan Error', 'QR code contains invalid ID format. Please scan a valid attendance QR code.', () => {
                    startScanner();
                });
                loadingIndicator.classList.add('hidden');
                return;
            }

            // Prepare data for API request
            const attendanceData = {
                student_id: parseInt(studentId), // Ensure studentId is an integer
                lecturer_id: parsedLecturerId,
                subject_id: parsedSubjectId
            };

            try {
                const response = await fetch(`${API_BASE_URL}/mark-attendance/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(attendanceData),
                });

                const data = await response.json();

                if (response.ok || response.status === 200) { // 200 OK for duplicate, 201 Created for new
                    attendanceMarked = true; // Set flag to prevent re-processing
                    showMessageBox('Attendance Status', data.message, () => {
                        // Optionally, redirect or clear message after a delay
                        // For now, just show the message and keep the scanner stopped.
                        messageArea.textContent = data.message;
                        messageArea.classList.remove('text-gray-600');
                        messageArea.classList.add('text-green-600', 'font-bold');
                        loadingIndicator.classList.add('hidden');
                        // You might want to add a button to go back or scan again here.
                    });
                } else {
                    // API returned an error
                    const errorMessage = data.error || 'An unknown error occurred.';
                    showMessageBox('Attendance Failed', errorMessage, () => {
                        startScanner(); // Restart scanner on failure
                    });
                    messageArea.classList.remove('text-gray-600', 'text-green-600', 'font-bold');
                    messageArea.classList.add('text-red-600');
                    loadingIndicator.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error marking attendance:', error);
                showMessageBox('Network Error', 'Could not connect to the server. Please check your internet connection or server status.', () => {
                    startScanner(); // Restart scanner on network error
                });
                messageArea.classList.remove('text-gray-600', 'text-green-600', 'font-bold');
                messageArea.classList.add('text-red-600');
                loadingIndicator.classList.add('hidden');
            }
        };

        // Function to handle scan errors
        const onScanError = (errorMessage) => {
            // console.warn(`QR Code Scan Error: ${errorMessage}`);
            // This can be noisy, so only log for debugging
        };

        // Function to start the QR scanner
        const startScanner = async () => {
            attendanceMarked = false; // Reset flag
            messageArea.textContent = `Hello, ${studentUsername}! Point your camera at the QR code.`;
            messageArea.classList.remove('text-green-600', 'text-red-600', 'font-bold');
            messageArea.classList.add('text-gray-600');
            loadingIndicator.classList.add('hidden');

            try {
                await html5QrCode.start({ facingMode: "environment" }, qrCodeConfig, onScanSuccess, onScanError);
                console.log("QR Code scanner started.");
            } catch (err) {
                console.error("Error starting QR scanner:", err);
                showMessageBox('Camera Access Denied', 'Could not access camera. Please ensure camera permissions are granted and no other app is using the camera.', () => {
                    // Optionally, provide manual input option or retry button
                });
            }
        };

        // Start the scanner when the page loads
        window.onload = startScanner;
    </script>
</body>
</html>
